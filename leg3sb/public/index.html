<!doctype html>
<html lang="zh-CN">
<head>
<style>
  /* ... styles are omitted for brevity ... */
</style>
</head>
<body>
  <script>
(function(){
  // --- 配置 ---
  const API_ENDPOINT = '/api/counter';
  const SYNC_INTERVAL_MS = 1000; 

  const clickThrottleMs = 50; 
  const MAX_CLICKS_PER_SYNC = 20;

  // --- 状态变量 ---
  let total = 0;
  let localClickBuffer = 0;
  let isSyncing = false;
  let lastClickTime = 0;

  const counterEl = document.getElementById('counter');
  const bgColors = [
    'rgba(0,0,0,0.45)', 'rgba(32,140,190,0.9)', 'rgba(255,69,0,0.85)',
    'rgba(70,70,70,0.7)', 'rgba(0,128,0,0.7)'
  ];

  // --- UI 更新函数 ---
  function updateCounterDisplay() {
    if (typeof total === 'number' && !isNaN(total)) {
      counterEl.textContent = `总傻逼 +${Math.round(total)}`;
    }
  }

  function createBarrage(x, y, text) {
    // ... function content is omitted for brevity ...
  }

  // --- 网络逻辑：GET ---
  async function fetchTotalCount() {
    try {
      const response = await fetch(API_ENDPOINT);
      if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
      const data = await response.json();
      if (data && typeof data.total === 'number') {
        // --- THIS IS THE FIX ---
        // Only update the total from a GET request if there are no pending local clicks.
        // This prevents a stale fetch response from overwriting an optimistic local update.
        if (localClickBuffer === 0) {
          total = data.total;
          updateCounterDisplay();
        }
        // --- END OF THE FIX ---
      } else {
        console.warn('Received invalid data from fetchTotalCount:', data);
      }
    } catch (error) {
      console.error("Error fetching total count:", error);
    }
  }
  
  // --- 网络逻辑：POST ---
  async function syncLocalClicks() {
    if (localClickBuffer === 0 || isSyncing) {
      return;
    }
    isSyncing = true;
    
    const clicksToSend = Math.min(localClickBuffer, MAX_CLICKS_PER_SYNC);
    localClickBuffer -= clicksToSend; 

    try {
      const response = await fetch(API_ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ incrementBy: clicksToSend })
      });
      if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
      const data = await response.json();
      if (data && typeof data.total === 'number') {
        total = data.total; // Authoritative update from the server
        updateCounterDisplay();
      } else {
        console.warn('Received invalid data from syncLocalClicks:', data);
        localClickBuffer += clicksToSend; // Re-add clicks to buffer on failed parse
      }
    } catch (error) {
      console.error("Error syncing clicks:", error);
      localClickBuffer += clicksToSend; // Re-add clicks to buffer on network error
    } finally {
      isSyncing = false;
    }
  }
  
  // --- 事件处理 ---
  function handlePointer(evt) {
    // ... function content is omitted for brevity ...
  }

  // --- NEW: UNIFIED SYNC/FETCH LOGIC ---
  async function syncOrFetch() {
    // ... function content is omitted for brevity ...
  }

  // --- 初始化 ---
  function initialize() {
    // ... function content is omitted for brevity ...
  }
  
  initialize();
})();
</script>
</body>
</html>
